Got it‚Äîhere‚Äôs the quick brainstorm, then your fully-revised, production-ready schema doc.

## Brainstorm (what needed fixing/adding)

* **RLS correctness:** Your `admin_manage_all_profiles` policy checked the **row‚Äôs role**, not the **auth user‚Äôs role** ‚Üí fixed via `EXISTS (SELECT ... WHERE p.id = auth.uid())`.
* **Status mismatch:** `messages` policy referenced `closed` while `bid_repair` uses `completed` ‚Üí aligned to `accepted|completed`.
* **Admin tabs coverage:** Added minimal, real DB for **wallets/transactions**, **listing approval**, **refunds**, **broadcast notifications**, **ads/campaigns**, **SEO pages/keywords**, **security logs**, **support tickets** so all Admin screens map to tables.
* **Indexes & idempotency:** Added `IF NOT EXISTS` indexes/DDL and a **chunked push** strategy to avoid CLI hangs.
* **Consistent hooks & relationships:** Tightened names and references.
* **Freya note:** Two-comment cap is handled in app logic; DB has what it needs.

---

# üìö Sublimes Drive ‚Äî Complete Database Schema Reference (v2, Revised)

> **Highlights:** RLS fixed, status enums aligned, admin modules added (wallets/transactions, refunds, approvals, notifications, ads, SEO, security, support), indexes & idempotent DDL, chunked CLI push.

## üóÇÔ∏è Contents

1. Core Tables ¬∑ 2) Admin Modules ¬∑ 3) RPC Functions ¬∑ 4) RLS Policies ¬∑ 5) Frontend Hooks ¬∑ 6) Relationships ¬∑ 7) Deployment ¬∑ 8) Notes

---

## üî• Core Tables

### 1) `profiles`

```sql
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE,
  full_name TEXT,
  display_name TEXT,
  avatar_url TEXT,
  cover_image TEXT,
  role TEXT NOT NULL DEFAULT 'browser' CHECK (role IN ('admin','editor','car_owner','garage_owner','browser')),
  bio TEXT,
  location TEXT,
  phone_number TEXT,
  is_verified BOOLEAN NOT NULL DEFAULT false,
  total_xp INTEGER NOT NULL DEFAULT 0,
  level INTEGER NOT NULL DEFAULT 1,
  followers_count INTEGER NOT NULL DEFAULT 0,
  following_count INTEGER NOT NULL DEFAULT 0,
  posts_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_profiles_role ON public.profiles(role);
CREATE INDEX IF NOT EXISTS idx_profiles_email ON public.profiles(email);
CREATE INDEX IF NOT EXISTS idx_profiles_display_name ON public.profiles(display_name);
CREATE INDEX IF NOT EXISTS idx_profiles_created ON public.profiles(created_at DESC);
```

### 2) Communities

`posts`, `comments`, `post_likes`, `post_saves`, `post_shares`

```sql
CREATE TABLE IF NOT EXISTS public.posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  body TEXT,
  media JSONB NOT NULL DEFAULT '[]',
  tags TEXT[] NOT NULL DEFAULT '{}',
  urgency TEXT CHECK (urgency IN ('low','medium','high','urgent')),
  car_brand TEXT, car_model TEXT,
  is_pinned BOOLEAN NOT NULL DEFAULT false,
  view_count INTEGER NOT NULL DEFAULT 0,
  like_count INTEGER NOT NULL DEFAULT 0,
  comment_count INTEGER NOT NULL DEFAULT 0,
  share_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_posts_user ON public.posts(user_id);
CREATE INDEX IF NOT EXISTS idx_posts_created ON public.posts(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_posts_urgency ON public.posts(urgency);
CREATE INDEX IF NOT EXISTS idx_posts_brand ON public.posts(car_brand);
CREATE INDEX IF NOT EXISTS idx_posts_pinned ON public.posts(is_pinned DESC);

CREATE TABLE IF NOT EXISTS public.comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  body TEXT NOT NULL,
  parent_comment_id UUID REFERENCES public.comments(id) ON DELETE CASCADE,
  like_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_comments_post ON public.comments(post_id);
CREATE INDEX IF NOT EXISTS idx_comments_parent ON public.comments(parent_comment_id);

CREATE TABLE IF NOT EXISTS public.post_likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT ux_post_like UNIQUE(post_id, user_id)
);

CREATE TABLE IF NOT EXISTS public.post_saves (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT ux_post_save UNIQUE(post_id, user_id)
);

CREATE TABLE IF NOT EXISTS public.post_shares (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
  user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  share_type TEXT NOT NULL CHECK (share_type IN ('link','whatsapp','twitter','facebook','email','other')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 3) Marketplace

`listings`, `listing_saves`

```sql
CREATE TABLE IF NOT EXISTS public.listings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL CHECK (category IN ('parts','accessories','tools','services','other')),
  condition TEXT CHECK (condition IN ('new','like-new','good','fair','poor')),
  price NUMERIC(10,2),
  currency TEXT NOT NULL DEFAULT 'AED',
  location TEXT,
  car_brand TEXT, car_model TEXT,
  media JSONB NOT NULL DEFAULT '[]',
  tags TEXT[] NOT NULL DEFAULT '{}',
  is_featured BOOLEAN NOT NULL DEFAULT false,
  is_sold BOOLEAN NOT NULL DEFAULT false,
  view_count INTEGER NOT NULL DEFAULT 0,
  save_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_listings_user ON public.listings(user_id);
CREATE INDEX IF NOT EXISTS idx_listings_category ON public.listings(category);
CREATE INDEX IF NOT EXISTS idx_listings_brand_model ON public.listings(car_brand, car_model);

CREATE TABLE IF NOT EXISTS public.listing_saves (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  listing_id UUID NOT NULL REFERENCES public.listings(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT ux_listing_save UNIQUE(listing_id, user_id)
);
```

### 4) Garages

`garages`, `garage_reviews`

```sql
CREATE TABLE IF NOT EXISTS public.garages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  location TEXT,
  phone TEXT, email TEXT, website TEXT,
  specialties TEXT[] NOT NULL DEFAULT '{}',
  rating NUMERIC(3,2) NOT NULL DEFAULT 0,
  review_count INTEGER NOT NULL DEFAULT 0,
  is_verified BOOLEAN NOT NULL DEFAULT false,
  is_featured BOOLEAN NOT NULL DEFAULT false,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','approved','rejected')),
  media JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_garages_owner ON public.garages(owner_id);
CREATE INDEX IF NOT EXISTS idx_garages_status ON public.garages(status);

CREATE TABLE IF NOT EXISTS public.garage_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  garage_id UUID NOT NULL REFERENCES public.garages(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
  review_text TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT ux_garage_review UNIQUE(garage_id, user_id)
);
```

### 5) Events

`events`, `event_attendees`

```sql
CREATE TABLE IF NOT EXISTS public.events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organizer_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  event_type TEXT CHECK (event_type IN ('meetup','exhibition','race','workshop','other')),
  start_date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ,
  location TEXT,
  max_attendees INTEGER,
  attendee_count INTEGER NOT NULL DEFAULT 0,
  is_featured BOOLEAN NOT NULL DEFAULT false,
  media JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_events_type ON public.events(event_type);

CREATE TABLE IF NOT EXISTS public.event_attendees (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID NOT NULL REFERENCES public.events(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'going' CHECK (status IN ('going','interested','not_going')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT ux_event_attendee UNIQUE(event_id, user_id)
);
```

### 6) Bid Repair

`bid_repair`, `bid_replies`

```sql
CREATE TABLE IF NOT EXISTS public.bid_repair (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  car_brand TEXT, car_model TEXT, car_year INTEGER,
  urgency TEXT CHECK (urgency IN ('low','medium','high','urgent')),
  budget_min NUMERIC(10,2), budget_max NUMERIC(10,2),
  status TEXT NOT NULL DEFAULT 'open' CHECK (status IN ('open','bidding','accepted','completed','cancelled')),
  media JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_bid_status ON public.bid_repair(status);

CREATE TABLE IF NOT EXISTS public.bid_replies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bid_id UUID NOT NULL REFERENCES public.bid_repair(id) ON DELETE CASCADE,
  garage_id UUID NOT NULL REFERENCES public.garages(id) ON DELETE CASCADE,
  price_estimate NUMERIC(10,2) NOT NULL,
  estimated_time TEXT,
  message TEXT,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','accepted','rejected')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_bid_replies_bid ON public.bid_replies(bid_id);
```

### 7) Offers

```sql
CREATE TABLE IF NOT EXISTS public.offers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  creator_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  offer_type TEXT CHECK (offer_type IN ('discount','service','product','event')),
  category TEXT,
  discount_percentage INTEGER,
  original_price NUMERIC(10,2),
  discounted_price NUMERIC(10,2),
  valid_from TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  valid_until TIMESTAMPTZ,
  max_claims INTEGER,
  claim_count INTEGER NOT NULL DEFAULT 0,
  is_active BOOLEAN NOT NULL DEFAULT true,
  media JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_offers_active ON public.offers(is_active);
```

### 8) Daily Challenges

`challenges`, `challenge_progress` (as in your draft ‚Äî unchanged, with NOT NULL defaults).

### 9) Messaging

```sql
CREATE TABLE IF NOT EXISTS public.messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bid_id UUID NOT NULL REFERENCES public.bid_repair(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  message_text TEXT NOT NULL,
  is_read BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_messages_bid ON public.messages(bid_id);
```

### 10) Service Logs

(as in your draft ‚Äî unchanged)

---

## üß≠ Admin Modules (new)

**Wallets & Transactions**

```sql
CREATE TABLE IF NOT EXISTS public.wallets (
  user_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
  balance NUMERIC(12,2) NOT NULL DEFAULT 0,
  last_activity TIMESTAMPTZ
);

CREATE TABLE IF NOT EXISTS public.wallet_transactions (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  txn_type TEXT NOT NULL CHECK (txn_type IN ('topup','spend','refund','adjust')),
  amount NUMERIC(12,2) NOT NULL,
  status TEXT NOT NULL DEFAULT 'processing' CHECK (status IN ('processing','completed','failed','refunded')),
  ref TEXT,
  meta JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_wallet_tx_user ON public.wallet_transactions(user_id);
```

**Listing Approval Queue**

```sql
CREATE TABLE IF NOT EXISTS public.listing_approval_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  listing_id UUID NOT NULL REFERENCES public.listings(id) ON DELETE CASCADE,
  payment_ref TEXT,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','approved','rejected')),
  reviewed_by UUID REFERENCES public.profiles(id),
  reviewed_at TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE UNIQUE INDEX IF NOT EXISTS ux_laq_listing ON public.listing_approval_queue(listing_id);
```

**Refunds**

```sql
CREATE TABLE IF NOT EXISTS public.refunds (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wallet_tx_id BIGINT REFERENCES public.wallet_transactions(id) ON DELETE SET NULL,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  amount NUMERIC(12,2) NOT NULL,
  reason TEXT,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','approved','rejected','processed')),
  attachments JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Notifications (Broadcast)**

```sql
CREATE TABLE IF NOT EXISTS public.notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  content TEXT,
  target_role TEXT,        -- NULL=all
  target_emirate TEXT,     -- NULL=all
  method TEXT NOT NULL DEFAULT 'push' CHECK (method IN ('push','email','sms')),
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft','scheduled','sent','failed')),
  scheduled_at TIMESTAMPTZ, sent_at TIMESTAMPTZ,
  stats JSONB NOT NULL DEFAULT '{}'  -- {delivered, opened...}
);

CREATE TABLE IF NOT EXISTS public.user_notifications (
  id BIGSERIAL PRIMARY KEY,
  notification_id UUID NOT NULL REFERENCES public.notifications(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  delivered BOOLEAN NOT NULL DEFAULT false,
  opened BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Ads & Monetization**

```sql
CREATE TABLE IF NOT EXISTS public.ad_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  objective TEXT,
  budget NUMERIC(12,2) NOT NULL DEFAULT 0,
  spent NUMERIC(12,2) NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','paused','completed')),
  placement TEXT,                -- banner/native/video
  meta JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.ad_impressions (
  id BIGSERIAL PRIMARY KEY,
  campaign_id UUID NOT NULL REFERENCES public.ad_campaigns(id) ON DELETE CASCADE,
  occurred_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  click BOOLEAN NOT NULL DEFAULT false
);
```

**SEO Center**

```sql
CREATE TABLE IF NOT EXISTS public.seo_pages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  path TEXT NOT NULL UNIQUE,
  title TEXT NOT NULL,
  description TEXT,
  keywords TEXT[] NOT NULL DEFAULT '{}',
  ranking INTEGER,
  traffic INTEGER NOT NULL DEFAULT 0,
  optimized BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.seo_keywords (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  keyword TEXT NOT NULL UNIQUE,
  position INTEGER,
  volume INTEGER,
  difficulty TEXT,
  trend JSONB NOT NULL DEFAULT '{}'
);
```

**Security & Support**

```sql
CREATE TABLE IF NOT EXISTS public.security_logs (
  id BIGSERIAL PRIMARY KEY,
  event TEXT NOT NULL, user_email TEXT,
  ip INET, location TEXT,
  severity TEXT NOT NULL DEFAULT 'low' CHECK (severity IN ('low','medium','high')),
  details JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.blocked_ips (
  ip INET PRIMARY KEY,
  reason TEXT,
  attempts INTEGER NOT NULL DEFAULT 0,
  blocked_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.support_tickets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  category TEXT,
  priority TEXT NOT NULL DEFAULT 'low' CHECK (priority IN ('low','medium','high','urgent')),
  status TEXT NOT NULL DEFAULT 'open' CHECK (status IN ('open','in_progress','resolved','escalated')),
  subject TEXT NOT NULL,
  messages JSONB NOT NULL DEFAULT '[]',
  assigned_to UUID REFERENCES public.profiles(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

---

## üõ†Ô∏è RPC (signatures)

* `fn_update_xp(p_user_id UUID, p_amount INT, p_reason TEXT)` ‚Üí `{success,new_xp,new_level}`
* `fn_get_leaderboard(p_timeframe TEXT, p_limit INT)` ‚Üí array of users
* `fn_toggle_like(p_post_id UUID)` ¬∑ `fn_toggle_save(p_post_id UUID)` ¬∑ `fn_track_share(p_post_id UUID, p_share_type TEXT)`
* `fn_toggle_listing_save(p_listing_id UUID)` ¬∑ `fn_register_listing_view(p_listing_id UUID, p_anon_hash TEXT)`
* `fn_admin_set_garage_status(p_garage_id UUID, p_status TEXT, p_reason TEXT)` ¬∑ `fn_admin_feature_garage(...)`
* `fn_register_event_attendance(p_event_id UUID, p_status TEXT)` ¬∑ `log_event(name, props JSONB)`
* `fn_track_view(entity_type, entity_id, session_id, ip, ua)` (10-min dedup)

---

## üîê RLS (enabled on all main tables)

**Profiles**

```sql
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY IF NOT EXISTS profiles_read_all
ON public.profiles FOR SELECT USING (true);

CREATE POLICY IF NOT EXISTS profiles_update_own
ON public.profiles FOR UPDATE
USING (auth.uid() = id) WITH CHECK (auth.uid() = id);

CREATE POLICY IF NOT EXISTS profiles_admin_manage_all
ON public.profiles FOR ALL
USING (EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.role IN ('admin','editor')));
```

**Posts** (CRUD own, read all, admins all) ‚Äì as above.

**Bid Repair**

```sql
CREATE POLICY IF NOT EXISTS bid_create_allowed_roles
ON public.bid_repair FOR INSERT
WITH CHECK (
  auth.uid() = user_id AND
  (SELECT role FROM public.profiles WHERE id = auth.uid()) IN ('car_owner','browser','admin')
);

CREATE POLICY IF NOT EXISTS bid_read_all
ON public.bid_repair FOR SELECT USING (true);

CREATE POLICY IF NOT EXISTS bid_update_own
ON public.bid_repair FOR UPDATE
USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
```

**Messages** (status aligned)

```sql
CREATE POLICY IF NOT EXISTS msg_insert_after_accept
ON public.messages FOR INSERT
WITH CHECK (
  (SELECT status FROM public.bid_repair WHERE id = bid_id) IN ('accepted','completed')
  OR EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.role = 'admin')
);

CREATE POLICY IF NOT EXISTS msg_select_sender_or_admin
ON public.messages FOR SELECT
USING (sender_id = auth.uid() OR EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.role='admin'));
```

*(Apply analogous policies to listings/events/etc.)*

---

## üîó Relationships

```
profiles (1) ‚Üí (N) posts, comments, listings, garages, events, bid_repair, service_logs
posts (1) ‚Üí (N) comments, post_likes, post_saves, post_shares
listings (1) ‚Üí (N) listing_saves, listing_approval_queue
garages (1) ‚Üí (N) garage_reviews, bid_replies
bid_repair (1) ‚Üí (N) bid_replies, messages
events (1) ‚Üí (N) event_attendees
wallets (1) ‚Üí (N) wallet_transactions
notifications (1) ‚Üí (N) user_notifications
```

---

## üöÄ Deployment

**Chunked, idempotent push (prevents CLI hangs).**

`scripts/db/push-chunked.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail
supabase db execute --file sql/00_core_tables.sql
supabase db execute --file sql/10_admin_modules.sql
supabase db execute --file sql/20_functions.sql
supabase db execute --file sql/30_rls.sql
# supabase db execute --file sql/40_seed.sql
```

Make each file **idempotent** (`IF NOT EXISTS`, `DROP POLICY IF EXISTS`) and group transactions sensibly.

**Verify**

```sql
SELECT table_name FROM information_schema.tables WHERE table_schema='public' ORDER BY table_name;
SELECT routine_name FROM information_schema.routines WHERE routine_schema='public' ORDER BY routine_name;
SELECT schemaname, tablename, policyname FROM pg_policies WHERE schemaname='public' ORDER BY tablename, policyname;
```

---

## üìù Notes & Conventions

* Never check admin via the **row**; always resolve `auth.uid()` ‚Üí `profiles.role`.
* Status terms are consistent (`accepted|completed`, etc.).
* Buckets via env: `brand-assets`, `user-avatars`, `post-media`, `listing-media`, `garage-media`.
* Fees example: Car AED 50 (+5% VAT), Parts 8% (+5% VAT), Garage AED 100 (+5% VAT) ‚Üí implement in `fn_calculate_fee`.
* **Freya AI**: enforce 2-comment cap per post in app layer; persist an audit to prevent duplicate actions.

---

**Last Updated:** 2025-11-06 ¬∑ **Scope:** 40+ tables, RLS hardened, Admin features aligned

---

### Want it as a file?

My file export tool glitched just now, so please copy this into `docs/db/schema-v2.md` (or tell me to try again and I‚Äôll regenerate a downloadable file right here).
